openapi: 3.0.3
info:
  title: Climate Invest Optimizer API
  description: |
    API REST para la optimización de presupuestos de inmuebles orientada a la prevención 
    y mitigación de riesgos climáticos.
    
    ## Características principales
    
    - **Gestión de inmuebles (Shops)**: CRUD completo de tiendas con información de localización y riesgos
    - **Evaluación de riesgos climáticos**: Análisis de exposición, sensibilidad y probabilidad por cluster
    - **Medidas preventivas**: Catálogo de medidas con costos estimados y tipos
    - **Optimización de presupuesto**: Algoritmos (greedy, knapsack, weighted) para maximizar reducción de riesgo
    - **Dashboard**: Estadísticas y métricas generales
    
    ## Autenticación
    
    La API utiliza autenticación JWT. Incluye el token en el header `Authorization`:
    ```
    Authorization: Bearer <token>
    ```
    
    ## Códigos de error
    
    | Código | Descripción |
    |--------|-------------|
    | 400 | Bad Request - Error de validación |
    | 401 | Unauthorized - Token inválido o expirado |
    | 403 | Forbidden - Sin permisos suficientes |
    | 404 | Not Found - Recurso no encontrado |
    | 409 | Conflict - Recurso duplicado |
    | 422 | Unprocessable Entity - Error de negocio |
    | 500 | Internal Server Error - Error del servidor |
    
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api/v1
    description: Development server
  - url: https://api.climate-invest.com/api/v1
    description: Production server

tags:
  - name: auth
    description: Autenticación y gestión de sesiones
  - name: shops
    description: Gestión de tiendas/inmuebles
  - name: clusters
    description: Agrupaciones geográficas
  - name: measures
    description: Medidas preventivas
  - name: risks
    description: Riesgos climáticos
  - name: optimization
    description: Optimización de presupuesto
  - name: dashboard
    description: Estadísticas y métricas
  - name: health
    description: Estado del sistema

paths:
  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Verifica que la API esté funcionando correctamente
      operationId: healthCheck
      responses:
        '200':
          description: API funcionando correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string
                    example: API is running
                  version:
                    type: string
                    example: 1.0.0

  /auth/login:
    post:
      tags:
        - auth
      summary: Iniciar sesión
      description: Autentica un usuario y retorna un token JWT
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/register:
    post:
      tags:
        - auth
      summary: Registrar usuario
      description: Crea una nueva cuenta de usuario
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Usuario registrado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'

  /auth/refresh:
    post:
      tags:
        - auth
      summary: Refrescar token
      description: Genera un nuevo token JWT a partir de uno existente
      operationId: refreshToken
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token refrescado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /shops:
    get:
      tags:
        - shops
      summary: Lista todas las tiendas
      description: Obtiene una lista paginada de tiendas con filtros opcionales
      operationId: listShops
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: cluster_id
          in: query
          description: Filtrar por ID de cluster
          schema:
            type: integer
        - name: min_risk
          in: query
          description: Riesgo mínimo
          schema:
            type: number
            format: float
        - name: max_risk
          in: query
          description: Riesgo máximo
          schema:
            type: number
            format: float
        - name: q
          in: query
          description: Búsqueda por localización
          schema:
            type: string
      responses:
        '200':
          description: Lista de tiendas
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PaginatedShops'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - shops
      summary: Crear tienda
      description: Crea una nueva tienda
      operationId: createShop
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateShopRequest'
      responses:
        '201':
          description: Tienda creada
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Shop'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /shops/{id}:
    get:
      tags:
        - shops
      summary: Obtener tienda por ID
      description: Retorna los detalles completos de una tienda
      operationId: getShop
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ShopIdParam'
      responses:
        '200':
          description: Detalles de la tienda
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ShopWithDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - shops
      summary: Actualizar tienda
      description: Actualiza parcialmente una tienda
      operationId: updateShop
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ShopIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateShopRequest'
      responses:
        '200':
          description: Tienda actualizada
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Shop'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - shops
      summary: Eliminar tienda
      description: Elimina una tienda y sus medidas asociadas
      operationId: deleteShop
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ShopIdParam'
      responses:
        '204':
          description: Tienda eliminada
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /shops/{id}/measures:
    post:
      tags:
        - shops
      summary: Aplicar medidas a tienda
      description: Aplica una o más medidas preventivas a una tienda
      operationId: applyMeasures
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ShopIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplyMeasuresRequest'
      responses:
        '200':
          description: Medidas aplicadas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /shops/{id}/risk-assessment:
    get:
      tags:
        - shops
      summary: Evaluación de riesgos
      description: Obtiene la evaluación de riesgos climáticos de una tienda
      operationId: getRiskAssessment
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ShopIdParam'
      responses:
        '200':
          description: Evaluación de riesgos
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/RiskAssessment'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /clusters:
    get:
      tags:
        - clusters
      summary: Lista todos los clusters
      description: Obtiene la lista de todos los clusters geográficos
      operationId: listClusters
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de clusters
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Cluster'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /clusters/{id}:
    get:
      tags:
        - clusters
      summary: Obtener cluster por ID
      description: Retorna los detalles de un cluster incluyendo sus riesgos
      operationId: getCluster
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Detalles del cluster
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ClusterWithRisks'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /measures:
    get:
      tags:
        - measures
      summary: Lista todas las medidas
      description: Obtiene el catálogo de medidas preventivas disponibles
      operationId: listMeasures
      security:
        - BearerAuth: []
      parameters:
        - name: type
          in: query
          description: Filtrar por tipo de medida
          schema:
            type: string
            enum: [natural, material, immaterial]
      responses:
        '200':
          description: Lista de medidas
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Measure'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risks:
    get:
      tags:
        - risks
      summary: Lista todos los riesgos
      description: Obtiene la lista de todos los riesgos climáticos
      operationId: listRisks
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de riesgos
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Risk'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /optimization/budget:
    post:
      tags:
        - optimization
      summary: Optimizar presupuesto
      description: |
        Calcula la distribución óptima de medidas preventivas para un presupuesto dado.
        
        ## Estrategias disponibles
        
        - **greedy**: Selecciona medidas por mejor ratio costo-beneficio. Rápido y efectivo.
        - **knapsack**: Programación dinámica para solución óptima. Más preciso pero costoso.
        - **weighted**: Considera prioridades de riesgos definidas por el usuario.
        
      operationId: optimizeBudget
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OptimizeBudgetRequest'
            examples:
              basic:
                summary: Optimización básica
                value:
                  shop_ids: [1, 2, 3]
                  max_budget: 50000
                  strategy: greedy
              withPriorities:
                summary: Con prioridades de riesgo
                value:
                  shop_ids: [1, 2, 3]
                  max_budget: 100000
                  strategy: weighted
                  risk_priorities: [1, 5, 8]
      responses:
        '200':
          description: Resultado de la optimización
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/OptimizationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /dashboard/stats:
    get:
      tags:
        - dashboard
      summary: Estadísticas del dashboard
      description: Retorna métricas generales para el dashboard principal
      operationId: getDashboardStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Estadísticas del dashboard
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DashboardStats'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtenido del endpoint /auth/login

  parameters:
    ShopIdParam:
      name: id
      in: path
      required: true
      description: ID de la tienda
      schema:
        type: integer
        format: int64
    PageParam:
      name: page
      in: query
      description: Número de página
      schema:
        type: integer
        default: 1
        minimum: 1
    PageSizeParam:
      name: page_size
      in: query
      description: Elementos por página
      schema:
        type: integer
        default: 20
        minimum: 1
        maximum: 100

  responses:
    BadRequest:
      description: Error de validación
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: VALIDATION_ERROR
              message: "El campo 'location' es requerido"
    Unauthorized:
      description: No autorizado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: UNAUTHORIZED
              message: Token de autenticación requerido
    Forbidden:
      description: Acceso denegado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: FORBIDDEN
              message: No tiene permisos para realizar esta acción
    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: NOT_FOUND
              message: Tienda no encontrada
    Conflict:
      description: Conflicto con recurso existente
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: DUPLICATE_RESOURCE
              message: El recurso ya existe
    UnprocessableEntity:
      description: Error de negocio
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: INSUFFICIENT_BUDGET
              message: El presupuesto es insuficiente para cualquier medida

  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Operación exitosa

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: ERROR_CODE
            message:
              type: string
              example: Descripción del error

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          example: secretpassword

    RegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: newuser@example.com
        password:
          type: string
          format: password
          minLength: 8
        role:
          type: string
          enum: [admin, manager, viewer]
          default: viewer

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            token:
              type: string
              example: eyJhbGciOiJIUzI1NiIs...
            expires_at:
              type: integer
              format: int64
              example: 1702684800
            user:
              type: object
              properties:
                id:
                  type: integer
                  example: 1
                email:
                  type: string
                  example: user@example.com
                role:
                  type: string
                  example: manager

    Shop:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        location:
          type: string
          example: Barcelona, Spain
        coordinate_x:
          type: number
          format: float
          example: 41.3851
        coordinate_y:
          type: number
          format: float
          example: 2.1734
        total_risk:
          type: number
          format: float
          example: 0.65
        taxonomy_coverage:
          type: number
          format: float
          example: 45.5
        surface:
          type: number
          format: float
          example: 2500
        carbon_footprint:
          type: number
          format: float
          example: 150.5
        cluster_id:
          type: integer
          format: int64
          example: 3

    ShopWithDetails:
      allOf:
        - $ref: '#/components/schemas/Shop'
        - type: object
          properties:
            cluster_name:
              type: string
              example: Mediterranean Coast
            risks:
              type: array
              items:
                $ref: '#/components/schemas/RiskDetail'
            applied_measures:
              type: array
              items:
                $ref: '#/components/schemas/Measure'

    CreateShopRequest:
      type: object
      required:
        - location
        - coordinate_x
        - coordinate_y
        - surface
        - cluster_id
      properties:
        location:
          type: string
          minLength: 3
          maxLength: 255
          example: Madrid, Spain
        coordinate_x:
          type: number
          format: float
          example: 40.4168
        coordinate_y:
          type: number
          format: float
          example: -3.7038
        surface:
          type: number
          format: float
          minimum: 0
          example: 3000
        carbon_footprint:
          type: number
          format: float
          minimum: 0
          example: 120
        cluster_id:
          type: integer
          format: int64
          example: 2

    UpdateShopRequest:
      type: object
      properties:
        location:
          type: string
          minLength: 3
          maxLength: 255
        coordinate_x:
          type: number
          format: float
        coordinate_y:
          type: number
          format: float
        surface:
          type: number
          format: float
          minimum: 0
        carbon_footprint:
          type: number
          format: float
          minimum: 0
        cluster_id:
          type: integer
          format: int64

    PaginatedShops:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Shop'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          example: 1
        page_size:
          type: integer
          example: 20
        total_items:
          type: integer
          format: int64
          example: 150
        total_pages:
          type: integer
          example: 8
        has_next:
          type: boolean
          example: true
        has_prev:
          type: boolean
          example: false

    Cluster:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: Mediterranean Coast
        coordinates_x:
          type: number
          format: float
          example: 41.0
        coordinates_y:
          type: number
          format: float
          example: 2.0

    ClusterWithRisks:
      allOf:
        - $ref: '#/components/schemas/Cluster'
        - type: object
          properties:
            risks:
              type: array
              items:
                $ref: '#/components/schemas/RiskDetail'

    Risk:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: Inundación costera/fluvial/pluvial
        svg:
          type: string
          nullable: true

    RiskDetail:
      allOf:
        - $ref: '#/components/schemas/Risk'
        - type: object
          properties:
            exposure:
              type: string
              enum: [very_low, low, medium, high, very_high]
              example: medium
            sensitivity:
              type: string
              enum: [very_low, low, medium, high, very_high]
              example: high
            consequence:
              type: string
              enum: [very_low, low, medium, high, very_high]
              example: high
            probability:
              type: string
              enum: [very_low, low, medium, high, very_high]
              example: medium
            risk_score:
              type: number
              format: float
              example: 0.42

    Measure:
      type: object
      properties:
        name:
          type: string
          example: Sistema de drenaje perimetral
        estimated_cost:
          type: number
          format: float
          example: 4500
        type:
          type: string
          enum: [natural, material, immaterial]
          example: material

    ApplyMeasuresRequest:
      type: object
      required:
        - measure_names
      properties:
        measure_names:
          type: array
          minItems: 1
          items:
            type: string
          example: ["Sistema de drenaje perimetral", "Aislamiento térmico continuo"]

    RiskAssessment:
      type: object
      properties:
        shop_id:
          type: integer
          format: int64
        overall_risk_score:
          type: number
          format: float
          example: 0.65
        risk_level:
          type: string
          enum: [very_low, low, medium, high, very_high]
          example: medium
        risks:
          type: array
          items:
            $ref: '#/components/schemas/RiskDetail'
        last_updated:
          type: string
          format: date-time

    OptimizeBudgetRequest:
      type: object
      required:
        - shop_ids
        - max_budget
      properties:
        shop_ids:
          type: array
          minItems: 1
          items:
            type: integer
            format: int64
          example: [1, 2, 3]
        max_budget:
          type: number
          format: float
          minimum: 0
          example: 50000
        strategy:
          type: string
          enum: [greedy, knapsack, weighted]
          default: greedy
          description: |
            - **greedy**: Rápido, buen balance costo-beneficio
            - **knapsack**: Óptimo pero más lento
            - **weighted**: Considera prioridades de riesgo
        risk_priorities:
          type: array
          items:
            type: integer
            format: int64
          description: IDs de riesgos prioritarios (solo para strategy=weighted)
          example: [1, 5]

    OptimizationResult:
      type: object
      properties:
        total_cost:
          type: number
          format: float
          example: 45500
        remaining_budget:
          type: number
          format: float
          example: 4500
        total_risk_reduction:
          type: number
          format: float
          description: Porcentaje de reducción de riesgo
          example: 35.5
        recommended_measures:
          type: array
          items:
            $ref: '#/components/schemas/RecommendedMeasure'
        shop_recommendations:
          type: array
          items:
            $ref: '#/components/schemas/ShopRecommendation'
        strategy_used:
          type: string
          example: greedy
        metrics:
          $ref: '#/components/schemas/OptimizationMetrics'

    RecommendedMeasure:
      type: object
      properties:
        measure:
          $ref: '#/components/schemas/Measure'
        priority:
          type: integer
          example: 1
        risk_reduction_percentage:
          type: number
          format: float
          example: 12.5
        cost_efficiency_score:
          type: number
          format: float
          example: 0.0028
        affected_risks:
          type: array
          items:
            type: string
          example: ["Inundación costera/fluvial/pluvial", "Precipitaciones intensas"]
        justification:
          type: string
          example: Medida con alta eficiencia que reduce riesgos relacionados con eventos climáticos

    ShopRecommendation:
      type: object
      properties:
        shop_id:
          type: integer
          format: int64
        shop_location:
          type: string
        current_risk:
          type: number
          format: float
        projected_risk:
          type: number
          format: float
        measures:
          type: array
          items:
            $ref: '#/components/schemas/RecommendedMeasure'
        estimated_investment:
          type: number
          format: float

    OptimizationMetrics:
      type: object
      properties:
        budget_utilization_percentage:
          type: number
          format: float
          example: 91.0
        average_risk_reduction:
          type: number
          format: float
          example: 15.5
        estimated_roi:
          type: number
          format: float
          example: 2.5
        processing_time_ms:
          type: integer
          format: int64
          example: 45

    DashboardStats:
      type: object
      properties:
        total_shops:
          type: integer
          format: int64
          example: 150
        total_clusters:
          type: integer
          format: int64
          example: 12
        average_risk:
          type: number
          format: float
          example: 0.45
        high_risk_shops:
          type: integer
          format: int64
          example: 23
        total_measures:
          type: integer
          format: int64
          example: 40
        applied_measures:
          type: integer
          format: int64
          example: 185
        total_investment:
          type: number
          format: float
          example: 450000
        coverage_percentage:
          type: number
          format: float
          example: 65.5
